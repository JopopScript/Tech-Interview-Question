# 쿠키, 세션, JWT

## 쿠키(Cookie)와 세션(Session)

### HTTP의 특징과 쿠키와 세션이 등장한 이유

HTTP는 비연결성과 무상태성 특징으로 요청에 대한 응답을 처리하면 연결을 끊어버립니다. 

연결 해제 후에 상태 정보를 저장하지 않기 떄문에 서버의 자원을 아낄 수 있다는 장점이 있지만, 서버는 클라이언트를 식별할 수 없다는 단점이 있습니다.

현재 우리가 이용하는 웹사이트는 로그인 한 번 하면 그 로그인 상태를 유지할 수 있는데, 이런 HTTP의 비연결성과 무상태성을 보완한 기술이 쿠키와 세션입니다.

### 쿠키

쿠키란 서버가 클라이언트의 웹 브라우저에 저장하는 데이터입니다. 

> 웹 서버는 쿠키를 이용해서 웹 브라우저에 정보를 전송할 수 있고 웹 서버로부터 쿠키를 전달받은 웹 브라우저는 웹 서버에 요청할 때 쿠키를 함께 전송합니다. 쿠키를 사용하면 서버와  브라우저는 데이터를 공유하고 상태 유지할 수 있습니다.

##### set-cookie : 클라이언트가 서버에 요청하면, **서버가 클라이언트로 전달**하는 쿠키 데이터

~~~http
MockHttpServletResponse:
           Status = 200
          Headers = [Set-Cookie:"userName=kevin", "password=abc123"]
~~~

- 서버가 클라이언트의 로그인 요청에 대한 응답을 작성하는 경우, **응답 헤더의 set-cookie**에 담아서 전달

- 쿠키는 key-value 형태

##### cookie : **클라이언트가 서버에서 받은 쿠키 저장하고, 서버로 전달**하는 쿠키 데이터 

~~~http
MockHttpServletRequest:
      HTTP Method = GET
      Request URI = /user/my/edit
          Headers = [Cookie:"userName=kevin"; "password=abc123"]
~~~

- 클라이언트는 요청을 보낼 때, 저장된 쿠키를 **요청 헤더의 cookie**에 담아서 전달
- 서버는 요청 헤더의 cookie 정보를 통해 클라이언트가 누군지 식별 가능

#### 쿠키 단점

- 보안에 취약합니다.
  - 요청 시 쿠키의 값을 그대로 보냅니다.
- 네트워크 트래픽을 유발합니다.
  - 쿠키는 항상 서버에 전송되기 때문에 최소한의 정보만 담아야 합니다.(세션 id, 인증 토큰 등)
  - 서버에 전송하고 싶지 않은 데이터는 쿠키 말고 웹 스토리지를 웹 브라우저에 저장하여 사용합니다.

#### 쿠키 사용처

- 사용자 로그인 세션 관리
  - 사용자 정보를 모두 쿠키에 담는 것이 아니라  로그인 성공하면, 세션 키를 만들어서 db에 저장해놓고 쿠키에 세션 키를 넣어서 클라이언트에 전달합니다.
  - 세션 키는 탈취당하면 안되므로 https를 사용하여 암호화하고, 세션의 생존 기간을 짧게 하는 방법이 있습니다.
- 7일간 다시 보지 않기(쿠키에 체크한 날짜를 기록하여 다시 방문 했을 때의 시간과 시차를 이용하여 계산)
- 최근 검색한 상품들을 광고에서 추천

### 세션

일정 시간 동안 같은 클라이언트로부터 들어오는 요청을 상태로 보고, 그 상태를 유지하는 기술이다.

쿠키만을 이용해서 로그인 상태를 유지한다고 가정하면, 아이디나 비밀번호 정보도 쿠키를 통해 전달하는 방법이 있습니다. 이 경우, 보안상 큰 문제가 되므로, 세션을 이용합니다. 

세션은 비밀번호가 아니라 (클라이언트의 식별자인) 세션 키를 만들어서 쿠키에 저장하고, 세션 키를 클라이언트에 전달합니다. 개인 정보(로그인 상태, 마지막 로그인 시간, 닉네임, 만료기한 등)는 서버에 저장합니다.

> 중요한 정보는 클라이언트가 아니라 서버에 저장하기 때문에 클라이언트 정보가 노출되지 않음

#### 특징

- 세션 아이디는 브라우저 단위로 저장되고 브라우저 종료시 소멸됩니다.

## 세션 기반 인증, 토큰 기반 인증

기존의 시스템은 서버 기반 인증 방식을 사용했으나, 현재는 토큰 기반 인증 방식을 사용합니다.

### 세션(서버) 기반 인증 -> 쿠키&세션 방식

세션(서버) 기반 인증 방식은 **서버 측에서 사용자들의 정보를 기억**하는 방식으로, 세션을 통해 기억합니다.

사용자가 로그인을 하면, 세션에 사용자 정보를 저장해두고 서비스를 제공할 때 사용하곤 한다. 이러한 서버 기반의 시스템은 다음과 같은 흐름을 갖습니다.

![image](https://user-images.githubusercontent.com/93963499/156915969-95be2933-db71-4623-9a01-9a8fc0c1a6e6.png)

1. 클라이언트가 로그인 요청
2. 서버 측에서는 해당 정보를 검증
3. 정보가 맞다면, 서버측에서 set-cookie를 통해 새로 발행한 세션id를  전달
4. 클라이언트는 요청 시 마다 서버에 저장된 세션id와 클라이언트에 있는 세션id가 일치한지 확인

이러한 인증 방식은 소규모 시스템에서 사용되고 있으나, 웹/앱 애플리케이션이 발달하게 되면서 서버 확장이 어렵다는 문제점이 있습니다.

#### 문제점

1. 서버 부하

서버에서 클라이언트의 상태를 모두 유지하고 있어야 하므로, 부하가 심합니다.

2. 확장성

사용자(클라이언트)가 늘어나게 되면, 더 많은 트래픽 처리를 위해 서버를 확장해야 하는데,  

확장 시 세션을  분산시키는 시스템을 설계해야 하며, 매우 복잡합니다.

3. CORS

웹 브라우저에서 세션 관리에 사용하는 쿠키는 단일 도메인 및 서브 도메인에서만 작동하도록 설계되어 CORS 방식(여러 도메인에 request를 보내는 브라우저)을 사용할 때 쿠키 및 세션 관리가 어렵습니다.

> 이부분은 CORS 이해가 필요

### 토큰 기반 인증 -> jwt 토큰 인증 방식

토큰 기반 인증 방식은 **인증 받은 사용자들에게 토큰을 발급하고, 서버에 요청을 할 때 헤더에 토큰을 함께 보내도록 하여 유효성 검사**를 하는 방식입니다.

이러한 시스템에서는 더이상 사용자의 인증 정보를 서버나 세션에 유지하지 않고 클라이언트 측에서 들어오는 요청만으로 작업을 처리합니다.

서버 기반의 인증 시스템과 달리 상태를 유지하지 않으므로 stateless한 구조를 갖습니다.

![image](https://user-images.githubusercontent.com/93963499/156916316-e579264c-f7e7-4946-8534-acb230977109.png)

1. 클라이언트가 로그인 요청
2. 서버 측에서는 해당 정보를 검증
3. 정보가 정확하다면 서버측에서 클라이언트에게 토큰을 전달
4. 클라이언트 측에서 전달받은 토큰을 저장해두고, 서버에 요청을 할 때마다 해당 토큰을 서버에 함께 전달
5. 서버는 토큰을 검증하고, 요청에 응답

#### 장점

1. 무상태성 , 확장성

토큰은 클라이언트 측에 저장되기 때문에 서버는 완전히 무상태성이며, 서버 확장이 용이해집니다.

2. 여러 플랫폼 및 도메인

서버 기반 인증 시스템의 문제점 중 하나인 CORS를 해결할 수 있습니다. 토큰을 사용한다면 어떤 디바이스, 어떤 도메인에서도 토큰의 유효성 검사를 진행한 후에 요청을 처리할 수 있습니다.

최근에는 JWT를 주로 사용합니다.

## JWT

JWT(JSON Web Token)란 인증에 필요한 정보들을 암호화시킨 토큰을 의미합니다.

JWT 기반 인증은 JWT 토큰(Access Token)을 HTTP 헤더에 실어 서버가 클라이언트를 식별할 수 있는 방식입니다.

### JWT 구조

![image](https://user-images.githubusercontent.com/93963499/156916623-3e12be35-67f5-4a9a-96d8-b08794ad13a0.png)

JWT는 .을 구분자로 나눈 세가지 문자열의 조합 (헤더, 페이로드, 시그너처)

- header : alg는 암호화할 해싱 알고리즘, typ는 토큰의 타입 지정

![image](https://user-images.githubusercontent.com/93963499/156916628-e8fd166e-2c12-4a52-bb44-04ed87043e36.png)

- payload : 토큰에 담을 정보, key-value 형태로 지정

![image](https://user-images.githubusercontent.com/93963499/156916638-045f4dee-f9d4-44d1-b1b8-63733d71d0a6.png)

- signature : 인코딩된 hader와 payload를 더한 뒤 비밀키로 해싱하여 생성

header와 payload는 단순 인코딩된 값이기 때문에 제 3자가 복호화 가능하지만, signature는 서버 측에서 관리하는 비밀키가 유출되지 않는 이상 복호화 불가능합니다.

signature는 토큰의 위변조 여부 확인할 때 사용됩니다.

![image](https://user-images.githubusercontent.com/93963499/156916652-380ca3d0-3f99-4fb1-a2a6-ae9cbb71ddd5.png)

#### 인증 과정

토큰 기반 인증 흐름과 같습니다.

#### 장점

1. 헤더와 페이로드를 가지고 시그너처를 생성하므로 **데이터 위변조를 막을 수 있습니다**. (토큰 의 위변조 여부)
2. 인증 정보에 대한 **별도 저장소가 필요 없습니다**. (토큰을 클라이언트에 저장해고 서버에 전달하기 때문)
3. JWT는 토큰에 대한 기본정보와 전달할 정보 및 토큰이 검증 서명 등 필요한 모든 정보를 지니고 있습니다. 
4. **서버에서 가장 피해야 할 부분은 데이터베이스 조회인데, jwt 토큰은 db 조회를 하지 않는다. 이 부분에서 성능적 이득이 크다.** 

#### 단점

1. 토큰은 한 번 발급되면, **유효기간이 만료될 때 계속 사용되어 탈취 당하게 되면 대처하기 어렵습니다.**
2. 쿠키/세션과 다르게 JWT는 토큰의 길이가 길어, 인증 요청이 많아질수록 네트워크 부하가 발생할 수 있습니다.
3. Payload 자체는 암호화 되지 않기 때문에 유저의 중요한 정보는 담을 수 없습니다. 

#### 보완 전략

jwt 사용시 단점 극복을 위해 다양한 전략을 채택할 수 있으나 각각의 장단점이 상이하므로 서비스의 특성을 고려하여 결정

1. 토큰 만료시간 짧게 설정

토큰이 탈취되더라도 만료되기 때문에 피해를 최소화할 수 있습니다. 하지만 클라이언트는 자주 로그인해야 합니다.

## 정리

- 세션 기반 vs 토큰 기반

  

  - 세션 기반 인증 방식

  서버측에서 인증 정보 관리하는 방식

  클라이언트의 요청이 있는 경우, 그 상태를 유지해놓고 사용합니다. 이것은 클라이언트가 증가함에 따라 확장성이 어렵고 성능의 문제가 생길 수 있습니다.
  

  - 토큰 기반 인증 방식

  이런 단점을 극복하기 위해 등장했으며, 클라이언트에게 토큰을 발급하고, 서버측에서 토큰을 검사하여 인증받은 클라이언트인지 확인하는 방식

  세션 기반(서버 기반) 방식과 달리 인증 상태를 유지하지 않으므로 stateless 한 특징이 있습니다.

  

- JWT 

  - JWT : 데이터 가지고 있는 위조 불가능한 문자열

  - JWT는 서명이 목적 !! 그 이유는 헤더, 페이로드는 복호화가 쉬우며, 암호화보다는 서명의 목적을 지님



|             | 장점                                                         | 단점                                              |
| ----------- | ------------------------------------------------------------ | ------------------------------------------------- |
| 쿠키 & 세션 | 쿠키만 사용하는 방식보다 보안 향상<br />서버 쪽에서 세션 통제 가능<br />네트워크 부하 낮음 | 세션 저장소 사용으로 서버 부하(DB 조회 부하 발생) |
| JWT         | 인증을 위한 저장소 필요 없음(DB조회 부하X)<br />확장성 우수<br /> | 토큰의 길이가 늘어나면 네트워크 부하 발생         |

### Reference

https://mangkyu.tistory.com/55

https://github.com/NKLCWDT/cs/blob/main/Network/Cookie%2C%20Session%2C%20JWT.md

https://tecoble.techcourse.co.kr/post/2021-05-22-cookie-session-jwt/

https://cjh5414.github.io/cookie-and-session/

https://inpa.tistory.com/entry/WEB-%F0%9F%93%9A-JWTjson-web-token-%EB%9E%80-%F0%9F%92%AF-%EC%A0%95%EB%A6%AC